{% extends "base.html" %} {% block title %}仪表板 - 植物叶片病害识别系统{%
endblock %} {% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-tachometer-alt me-2"></i>系统仪表板
        </h2>
        <p class="text-muted mb-4">系统运行状态和统计信息概览</p>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4" id="statsCards">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                <h4 class="mb-1" id="totalModels">-</h4>
                <p class="text-muted mb-0">可用模型</p>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-database fa-2x text-success mb-2"></i>
                <h4 class="mb-1" id="totalSamples">-</h4>
                <p class="text-muted mb-0">数据样本</p>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                <h4 class="mb-1" id="recentEvaluations">-</h4>
                <p class="text-muted mb-0">最近评估</p>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-microchip fa-2x text-warning mb-2"></i>
                <h4 class="mb-1" id="gpuStatus">-</h4>
                <p class="text-muted mb-0">GPU状态</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 模型信息 -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-brain me-2"></i>模型统计</h5>
            </div>
            <div class="card-body">
                <canvas id="modelChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- 数据集分布 -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>数据集分布
                </h5>
            </div>
            <div class="card-body">
                <canvas id="datasetChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 最近评估结果 -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>最近评估结果
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="evaluationTable">
                        <thead>
                            <tr>
                                <th>模型类型</th>
                                <th>准确率</th>
                                <th>F1分数</th>
                                <th>评估时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统信息 -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-server me-2"></i>系统信息</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">GPU可用性</small>
                    <p class="mb-0" id="gpuAvailable">-</p>
                </div>
                <div class="mb-3">
                    <small class="text-muted">GPU数量</small>
                    <p class="mb-0" id="gpuCount">-</p>
                </div>
                <div class="mb-3">
                    <small class="text-muted">当前时间</small>
                    <p class="mb-0" id="currentTime">-</p>
                </div>
                <div class="mb-0">
                    <small class="text-muted">系统状态</small>
                    <p class="mb-0">
                        <span class="badge bg-success">运行正常</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    $(document).ready(function () {
        // 加载仪表板数据
        loadDashboardData();

        // 每30秒刷新一次数据
        setInterval(loadDashboardData, 30000);

        function loadDashboardData() {
            $.ajax({
                url: "/api/dashboard_data",
                type: "GET",
                success: function (data) {
                    updateStatsCards(data);
                    updateCharts(data);
                    updateEvaluationTable(data.recent_evaluations);
                    updateSystemInfo(data.system_info);
                },
                error: function (xhr) {
                    console.error("Failed to load dashboard data:", xhr);
                },
            });
        }

        function updateStatsCards(data) {
            document.getElementById("totalModels").textContent =
                data.models_info.total_models;
            document.getElementById("totalSamples").textContent =
                data.dataset_stats.total_samples.toLocaleString();
            document.getElementById("recentEvaluations").textContent =
                data.recent_evaluations.length;

            const gpuStatus = data.system_info.gpu_available
                ? `${data.system_info.gpu_count} GPU`
                : "无GPU";
            document.getElementById("gpuStatus").textContent = gpuStatus;
        }

        function updateCharts(data) {
            // 模型类型分布图
            const modelCtx = document
                .getElementById("modelChart")
                .getContext("2d");

            // 销毁现有图表
            if (window.modelChart) {
                window.modelChart.destroy();
            }

            window.modelChart = new Chart(modelCtx, {
                type: "doughnut",
                data: {
                    labels: Object.keys(data.models_info.model_types),
                    datasets: [
                        {
                            data: Object.values(data.models_info.model_types),
                            backgroundColor: [
                                "#2c5530",
                                "#4a7c59",
                                "#7fb069",
                                "#b8e6b8",
                            ],
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: "bottom",
                        },
                    },
                },
            });

            // 数据集分布图
            const datasetCtx = document
                .getElementById("datasetChart")
                .getContext("2d");

            // 销毁现有图表
            if (window.datasetChart) {
                window.datasetChart.destroy();
            }

            window.datasetChart = new Chart(datasetCtx, {
                type: "bar",
                data: {
                    labels: Object.keys(data.dataset_stats.split_distribution),
                    datasets: [
                        {
                            label: "样本数量",
                            data: Object.values(
                                data.dataset_stats.split_distribution
                            ),
                            backgroundColor: "#7fb069",
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                        },
                    },
                },
            });
        }

        function updateEvaluationTable(evaluations) {
            const tbody = document.querySelector("#evaluationTable tbody");

            if (evaluations.length === 0) {
                tbody.innerHTML =
                    '<tr><td colspan="4" class="text-center text-muted">暂无评估记录</td></tr>';
                return;
            }

            tbody.innerHTML = evaluations
                .map(
                    (eval) => `
            <tr>
                <td>
                    <span class="badge bg-secondary">${eval.model_type}</span>
                </td>
                <td>${(eval.accuracy * 100).toFixed(1)}%</td>
                <td>${(eval.f1_score * 100).toFixed(1)}%</td>
                <td>${formatDateTime(eval.timestamp)}</td>
            </tr>
        `
                )
                .join("");
        }

        function updateSystemInfo(systemInfo) {
            document.getElementById("gpuAvailable").textContent =
                systemInfo.gpu_available ? "是" : "否";
            document.getElementById("gpuCount").textContent =
                systemInfo.gpu_count;
            document.getElementById("currentTime").textContent = formatDateTime(
                systemInfo.current_time
            );
        }
    });
</script>
{% endblock %}
